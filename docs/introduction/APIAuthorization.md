# API Authorization

## API key Introduction
Allxon API uses **API key** to authenticate request. You can view and manage API key in the [Allxon portal](https://dms.allxon.com/developer/apikeys).

The API key is in a key-pair structure. Each contain a one-on-one relation with the **Key ID** and the **Secret**. 

Ex:
```json
"Key ID": "Secret"
```

> **Secure your API key's secret**
>
> Your API key's secret must be treated like password. To keep your integration secure, never store the secret in your source code or commit it in version control. Instead, Use a secret manager or deployment system to read the secret.

Every request in Allxon API must contain an authorization that generated by API key and must be made over HTTPS.

## Authenticating Requests

Your authorization must be set at the `Authorization` header in every request.

The following is an example of the Authorization header value:
```
Authorization: ALLXON-SIG1 Credential="Key ID",Signature="request signature"
```

The following table describes the various components of the Authorization header value in the preceding example:
- `ALLXON-SIG1`: The algorithm that was used to calculate the signature. You must provide this value when you use Allxon Signature Version 1 for authentication. The `ALLXON-SIG1` specifies Allxon Signature Version 1.
- `Credential`: Your API key's `Key ID`. 
- `Signature`: Hex encoded form of SHA-256 hash.That be [generated](#signature-calculation) from your API key.

### Signature Generation
Each API request must include a signature. Use your API key's secret to derive a signing key, and then calculate a signature.

The following diagram illustrates the general process of computing a signature.
> 圖片 from https://confluence.xizhi.allxon.com/display/ADM/Design+for+3rd+party+integration+API#Designfor3rdpartyintegrationAPI-SigningRequests

```
SigningKey = Hex(HMAC-SHA256("<APISecretAccessKey>", STR(FLOOR(<X-Allxon-Epoch> / 3600000))))

Signature = Hex(HMAC-SHA256("<SigningKey>", "<HTTPMethod>" + "<EndpointPathWithSearch>" + "<X-Allxon-Epoch>"))
```

Here is the noun in the diagram
- X-Allxon-Epoch: The timestamp in milliseconds, as same as in the [request header](./APIOverview.md#request-header).
- HMAC-SHA256(): Computes HMAC by using the SHA256 algorithm with the signing key provided.
- FLOOR(): Rounds down and returns the largest integer less than or equal to a given number.
- STR(): Converts the specified value into a string.
- Hex(): Lowercase base 16 encoding.
- HTTPMethod: Your request HTTP method.
- EndpointPathWithSearch: The api endpoint path and the search, ex: `/path?search=xxx`

#### Step By Step
For example, Your 
- **Key ID** is `APIAEXAMPLEKEYID`
- **Secret** is `EPqeEGVcYf6Zpo+6yCqHeoYJSrnDykc9gPShOA==`
- **X-Allxon-Epoch** current epoch timestamp in milliseconds is `1708954065872`.
##### Derive the signing key
```
SigningKey = Hex(
        HMAC-SHA256(
            "EPqeEGVcYf6Zpo+6yCqHeoYJSrnDykc9gPShOA==", 
            STR(FLOOR(1708954065872 / 3600000))
        )
    )
          = "9e73a5982eb5a38cb36830773eb92d0d12cbece741a9c95cdab678f1971eb58d"
```
##### Calculate the signature
```
Signature = Hex(
        HMAC-SHA256(
            "9e73a5982eb5a38cb36830773eb92d0d12cbece741a9c95cdab678f1971eb58d",
            "POST/ota/deployment1708954065872"
        )
    )
          = "77d0a82a06cf01f53fc0d4e2273fc97f876041310790625533de79198ca90379"
```
##### Set the Authorization header
```
Authorization: ALLXON-SIG1 Credential="APIAEXAMPLEKEYID",Signature="77d0a82a06cf01f53fc0d4e2273fc97f876041310790625533de79198ca90379"
```